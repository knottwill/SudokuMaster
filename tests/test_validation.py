import numpy as np
from src.puzzleloading.validation import validate_form, validate_puzzle


def test_validate_form():
    """
    Test validate_form
    """

    # test it works for valid puzzle with valid format
    valid_form1 = "tests/test_puzzles/valid.txt"
    puzzle1 = np.array(
        [
            [0, 0, 0, 0, 0, 7, 0, 0, 0],
            [0, 0, 0, 0, 0, 9, 5, 0, 4],
            [0, 0, 0, 0, 5, 0, 1, 6, 9],
            [0, 8, 0, 0, 0, 0, 3, 0, 5],
            [0, 7, 5, 0, 0, 0, 2, 9, 0],
            [4, 0, 6, 0, 0, 0, 0, 8, 0],
            [7, 6, 2, 0, 8, 0, 0, 0, 0],
            [1, 0, 3, 9, 0, 0, 0, 0, 0],
            [0, 0, 0, 6, 0, 0, 0, 0, 0],
        ]
    )
    with open(valid_form1, "r") as file:
        text = file.read()
        valid, output = validate_form(text)
        assert valid
        assert np.array_equal(output, puzzle1)

    # test it works for puzzle with invalid format
    invalid_form1 = "tests/test_puzzles/invalid_form.txt"
    with open(invalid_form1, "r") as file:
        text = file.read()
        valid, output = validate_form(text)
        assert not valid
        assert output == "Too many digits on one or more rows."

    # test it works for invalid puzzle with valid format
    valid_form2 = "tests/test_puzzles/invalid_puzzle.txt"
    puzzle2 = np.array(
        [
            [0, 0, 0, 0, 0, 7, 5, 0, 0],  # notice 5 is used twice in the 7th column
            [0, 0, 0, 0, 0, 9, 5, 0, 4],
            [0, 0, 0, 0, 5, 0, 1, 6, 9],
            [0, 8, 0, 0, 0, 0, 3, 0, 5],
            [0, 7, 5, 0, 0, 0, 2, 9, 0],
            [4, 0, 6, 0, 0, 0, 0, 8, 0],
            [7, 6, 2, 0, 8, 0, 0, 0, 0],
            [1, 0, 3, 9, 0, 0, 0, 0, 0],
            [0, 0, 0, 6, 0, 0, 0, 0, 0],
        ]
    )
    with open(valid_form2, "r") as file:
        text = file.read()
        valid, output = validate_form(text)
        assert valid
        assert np.array_equal(output, puzzle2)


def test_validate_puzzle():
    # valid puzzle
    puzzle = np.array(
        [
            [0, 0, 0, 0, 0, 7, 0, 0, 0],
            [0, 0, 0, 0, 0, 9, 5, 0, 4],
            [0, 0, 0, 0, 5, 0, 1, 6, 9],
            [0, 8, 0, 0, 0, 0, 3, 0, 5],
            [0, 7, 5, 0, 0, 0, 2, 9, 0],
            [4, 0, 6, 0, 0, 0, 0, 8, 0],
            [7, 6, 2, 0, 8, 0, 0, 0, 0],
            [1, 0, 3, 9, 0, 0, 0, 0, 0],
            [0, 0, 0, 6, 0, 0, 0, 0, 0],
        ]
    )
    assert validate_puzzle(puzzle) == "Valid"

    # invalid puzzle due to invalid dimensions
    puzzle = np.array(
        [
            [0, 0, 0, 0, 0, 7, 0, 0, 0],
            [0, 0, 0, 0, 0, 9, 5, 0, 4],
            [0, 0, 0, 0, 5, 0, 1, 6, 9],
            [0, 8, 0, 0, 0, 0, 3, 0, 5],
        ]
    )
    assert validate_puzzle(puzzle) == "Invalid dimensions"

    # empty puzzle
    puzzle = np.zeros((9,9))
    assert validate_puzzle(puzzle) == "Puzzle is empty"

    # invalid entry
    puzzle = np.array(
        [
            [11, 0, 0, 0, 0, 7, 0, 0, 0],  # number 11 in first square
            [0, 0, 0, 0, 0, 9, 5, 0, 4],
            [0, 0, 0, 0, 5, 0, 1, 6, 9],
            [0, 8, 0, 0, 0, 0, 3, 0, 5],
            [0, 7, 5, 0, 0, 0, 2, 9, 0],
            [4, 0, 6, 0, 0, 0, 0, 8, 0],
            [7, 6, 2, 0, 8, 0, 0, 0, 0],
            [1, 0, 3, 9, 0, 0, 0, 0, 0],
            [0, 0, 0, 6, 0, 0, 0, 0, 0],
        ]
    )
    assert validate_puzzle(puzzle) == "Invalid entries"

    # duplicate numbers in blocks
    puzzle = np.array(
        [
            [0, 0, 0, 0, 0, 7, 0, 0, 0],
            [0, 0, 0, 0, 0, 9, 5, 0, 4],  # duplicate 4 in top right block
            [0, 0, 0, 0, 5, 0, 1, 4, 9],
            [0, 8, 0, 0, 0, 0, 3, 0, 5],
            [0, 7, 5, 0, 0, 0, 2, 9, 0],
            [4, 0, 6, 0, 0, 0, 0, 8, 0],
            [7, 6, 2, 0, 8, 0, 0, 0, 0],
            [1, 0, 3, 9, 0, 0, 0, 0, 0],
            [0, 0, 0, 6, 0, 0, 0, 0, 0],
        ]
    )
    assert validate_puzzle(puzzle) == "Duplicate numbers in block(s)"

    # duplicate numbers in row
    puzzle = np.array(
        [
            [0, 0, 7, 0, 0, 7, 0, 0, 0],  # duplicate 7 in top row
            [0, 0, 0, 0, 0, 9, 5, 0, 4],
            [0, 0, 0, 0, 5, 0, 1, 0, 9],
            [0, 8, 0, 0, 0, 0, 3, 0, 5],
            [0, 7, 5, 0, 0, 0, 2, 9, 0],
            [4, 0, 6, 0, 0, 0, 0, 8, 0],
            [7, 6, 2, 0, 8, 0, 0, 0, 0],
            [1, 0, 3, 9, 0, 0, 0, 0, 0],
            [0, 0, 0, 6, 0, 0, 0, 0, 0],
        ]
    )
    assert validate_puzzle(puzzle) == "Duplicate numbers in row(s)"

    # duplicate numbers in column
    puzzle = np.array(
        [
            [1, 0, 0, 0, 0, 7, 0, 0, 0],  # duplicate 1 in right hand column
            [0, 0, 0, 0, 0, 9, 5, 0, 4],
            [0, 0, 0, 0, 5, 0, 1, 0, 9],
            [0, 8, 0, 0, 0, 0, 3, 0, 5],
            [0, 7, 5, 0, 0, 0, 2, 9, 0],
            [4, 0, 6, 0, 0, 0, 0, 8, 0],
            [7, 6, 2, 0, 8, 0, 0, 0, 0],
            [1, 0, 3, 9, 0, 0, 0, 0, 0],
            [0, 0, 0, 6, 0, 0, 0, 0, 0],
        ]
    )
    assert validate_puzzle(puzzle) == "Duplicate numbers in column(s)"
